---
title: "APICS"
author: "Thao Nguyen"
date: "2023-05-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r libraries loading}
library(tidyverse)
library(dplyr)
library(gtsummary)
library(ggplot2)
library(table1)
```

```{r files loading}
admission_file <- list.files(path = "C:/Thaontp/Thao/APICS/Data-analysis",
												pattern = "CoreForms.*.csv",
												recursive = TRUE)
admission <- do.call(rbind, lapply(admission_file, function(x) read.csv(x, stringsAsFactors = FALSE)))

daily_file <- list.files(path = "C:/Thaontp/Thao/APICS/Data-analysis",
									 pattern = "Daily.*.csv",
									 recursive = TRUE)

daily <- do.call(rbind, lapply(daily_file, function(x) read.csv(x, stringsAsFactors = FALSE)))

note_file <- list.files(path = "C:/Thaontp/Thao/APICS/Data-analysis",
												pattern = "Notes.*.csv",
												recursive = TRUE)
note <- do.call(rbind, lapply(note_file, function(x) read.csv(x, stringsAsFactors = FALSE)))

teadmission_file <- list.files(path = "C:/Thaontp/Thao/APICS/Data-analysis",
															 pattern = ".*Admission.*.csv",
															 recursive = TRUE)

teadmission <- do.call(rbind, lapply(teadmission_file, function(x) read.csv(x, stringsAsFactors = FALSE)))

tedischarge_files <- list.files(path = "C:/Thaontp/Thao/APICS/Data-analysis",
																pattern = ".*Discharge.*.csv",
																recursive = TRUE)

tedischarge <- do.call(rbind, lapply(tedischarge_files, function(x) read.csv(x, stringsAsFactors = FALSE)))

```

```{r clean}

teadmission <- teadmission %>% mutate_at(vars("date_of_admission", "date_of_admission_hospital"), ~as.Date(.))

teadmission <- teadmission %>% filter(date_of_admission >= "2021-01-01")

tedischarge <- tedischarge %>% filter(patient_id %in% teadmission$patient_id)

admission <- admission %>% mutate_at(vars("date_of_admission", "date_of_admission_hospital", "Discharge.date_of_discharge", "Discharge.date_of_hospital_discharge"), ~as.Date(.))

admission_date <- admission %>% 
	select(patient_id, date_of_admission)

admission <- admission %>% 
	filter(patient_id %in% teadmission$patient_id) %>% 
	select(patient_id, Admission.age, Admission.gender, Admission.fee_paying_method, Admission.comorbid_conditions, AdmissionAssessment.mechanically_ventilated, AdmissionAssessment.mechanically_ventilated_source, AdmissionAssessment.gcs_eye:AdmissionAssessment.gcs_motor, date_of_admission, date_of_admission_hospital, Discharge.date_of_discharge, Discharge.date_of_hospital_discharge, Discharge.discharge_status, AdmissionAssessment.antibiotics_pre_icu_admission, AdmissionAssessment.name_of_the_antibiotic:AdmissionAssessment.name_of_the_antibiotic_other, AdmissionAssessment.mechanically_ventilated, Discharge.cost_icu, Discharge.hospital_cost, Discharge.icu_cost, Discharge.hospital_discharge_status)

admission <- admission %>% 
	mutate_at(vars("AdmissionAssessment.name_of_the_antibiotic", "AdmissionAssessment.name_of_the_antibiotic2", "AdmissionAssessment.name_of_the_antibiotic3", "AdmissionAssessment.name_of_the_antibiotic4", "AdmissionAssessment.name_of_the_antibiotic5", "AdmissionAssessment.name_of_the_antibiotic_other"), ~ na_if(.,""))

upgrade <- tedischarge %>% select(patient_id, TetanusPreDischarge.mechanically_ventilated)

admission <- left_join(admission, upgrade, by = "patient_id")

admission <- admission %>% 
	mutate(Admission.comorbid_conditions = ifelse(Admission.comorbid_conditions == "None", "No", "Yes"),
				 icustay = as.numeric(Discharge.date_of_discharge - date_of_admission),
				 hosstay = as.numeric(Discharge.date_of_hospital_discharge - date_of_admission_hospital),
				 upgrade = ifelse(AdmissionAssessment.mechanically_ventilated == "self_vent" & TetanusPreDischarge.mechanically_ventilated == "mechanical_vent", "Yes", "No"),
				 Insurance = ifelse(Admission.fee_paying_method == "Self/out of pocket", "No", "Yes"))

admission <- admission %>% 
	mutate(antibiotics = rowSums(!is.na(select(., AdmissionAssessment.name_of_the_antibiotic: AdmissionAssessment.name_of_the_antibiotic_other))))

##GCS

admission <- admission %>% 
	mutate(eye = case_when(AdmissionAssessment.gcs_eye == "Eye opening spontaneously" ~ 4,
												 AdmissionAssessment.gcs_eye == "Eye opening to Speech" ~ 3,
												 AdmissionAssessment.gcs_eye == "Eye opening in response to pain" ~ 2,
												 TRUE ~ 1),
				 verbal = case_when(AdmissionAssessment.gcs_verbal == "Oriented" ~ 5,
				 									 AdmissionAssessment.gcs_verbal == "Confused" ~ 4,
				 									 AdmissionAssessment.gcs_verbal == "Inappropriate words" ~ 3,
				 									 AdmissionAssessment.gcs_verbal == "Incomprehensible sounds" ~ 2,
				 									 TRUE ~ 1),
				 motor = case_when(AdmissionAssessment.gcs_motor == "Obeys Commands" ~ 6,
				 									AdmissionAssessment.gcs_motor == "Locailzes to pain" ~ 5,
				 									AdmissionAssessment.gcs_motor == "Withdraws from pain" ~ 4,
				 									AdmissionAssessment.gcs_motor == "Flexion in response to pain" ~ 3,
				 									AdmissionAssessment.gcs_motor == "Extension to pain" ~ 2,
				 									TRUE ~ 1))

admission <- admission %>% mutate(gcs = eye + verbal + motor)

admission <- admission %>% 
	group_by(patient_id) %>% 
	mutate(Discharge.cost_icu = ifelse(is.na(Discharge.cost_icu), as.numeric(max(Discharge.hospital_cost, Discharge.icu_cost, na.rm = TRUE)), as.numeric(Discharge.cost_icu))) %>% 
	ungroup() %>% 
	select(-c(Admission.fee_paying_method, AdmissionAssessment.mechanically_ventilated, AdmissionAssessment.mechanically_ventilated_source:Discharge.date_of_hospital_discharge, starts_with("AdmissionAssessment.name_of_the_antibiotic"), Discharge.hospital_cost:TetanusPreDischarge.mechanically_ventilated, eye:motor))


tetanus <- teadmission %>% 
	select(patient_id, TetanusAdmission.ablett_score, TetanusAdmission.asa_score, TetanusAdmission.occupation, TetanusAdmission.address, TetanusAdmission.source_of_admission, TetanusAdmission.wound, TetanusAdmission.incubation_period, TetanusAdmission.time_period_from_1st_symptom_to_hospital_admis, TetanusAdmission.period_of_onset)

tetanus <- tetanus %>% mutate(Place = ifelse(str_detect(TetanusAdmission.address, regex("HCM|HCMC|Chi Minh|TPHCM", ignore_case = TRUE)) == TRUE, "HCM City", "Country side"),
															Occupation = ifelse(!TetanusAdmission.occupation %in% c("Farmer", "Worker", "Elderly"), "Other", TetanusAdmission.occupation),
															Ablett = case_when(TetanusAdmission.ablett_score %in% c("No spasm", "Spasm not interfering with respiration") ~ "Cluster 1",
																								 TRUE ~ "Cluster 2"),
															ASA = case_when(TetanusAdmission.asa_score == "Fit and well" ~ 1,
																							TetanusAdmission.asa_score == "Minor ilness or injury" ~ 2,
																							TetanusAdmission.asa_score == "Moderately severe disease" ~ 3,
																							TetanusAdmission.asa_score == "Severe illness not immediately life-threatening" ~ 4,
																							TRUE ~ 5),
															Timeonset = extract_numeric(TetanusAdmission.period_of_onset))

admission <- left_join(admission, tetanus, by = "patient_id")


##Predischarge

predischarge <- tedischarge %>% 
	select(patient_id, TetanusPreDischarge.start_date1, starts_with("TetanusPreDischarge.pre_discharge_complication")) %>% 
	left_join(admission_date, by = "patient_id") %>% 
	mutate(ANSD = rowSums(select(.,starts_with("TetanusPreDischarge.pre_discharge_complication")) == "Autonomic dysfunction"),
				 Sepsis = rowSums(select(.,starts_with("TetanusPreDischarge.pre_discharge_complication")) == "Sepsis"),
				 TetanusPreDischarge.start_date1 = as.Date(TetanusPreDischarge.start_date1),
				 Time_Ablett = as.numeric(TetanusPreDischarge.start_date1 - date_of_admission)) %>% 
	select(patient_id, ANSD, Sepsis, Time_Ablett)

predischarge <- predischarge %>% 
	mutate(ANSD = if_else(ANSD == 1, "Yes", "No", "No"),
				 Sepsis = if_else(Sepsis == 1, "Yes", "No", "No"))

admission <- admission %>% 
	left_join(predischarge, by = "patient_id")

##Daily

daily_dt <- daily %>% 
	filter(patient_id %in% teadmission$patient_id) %>% 
	select(patient_id, DailyAssessment.date_of_daily_assessment, DailyAssessment.mechanically_ventilated, DailyAssessment.urinary_catheterization, starts_with(c("DailyAssessment.infection", "DailyAssessment.source", "DailyAssessment.hos_acquired", "DailyAssessment.culture_report", "DailyAssessment.culture_date", "DailyAssessment.type_of_culture", "DailyAssessment.organism"))) %>% 
	left_join(admission_date, by= "patient_id")

##Count days

days_of_inter <- daily_dt %>% 
	arrange(patient_id, DailyAssessment.date_of_daily_assessment) %>% 
	group_by(patient_id) %>% 
	mutate(Ventday = sum(DailyAssessment.mechanically_ventilated == "mechanical_vent"),
				 Urinecath = sum(DailyAssessment.urinary_catheterization %in% c("Insitu", "New")),
				 Firsturine = ifelse(DailyAssessment.urinary_catheterization %in% c("Insitu", "New"), DailyAssessment.date_of_daily_assessment, NA),
				 Firsturine = as.Date(Firsturine[which.min(is.na(Firsturine))]),
				 Time_to_first_urine = as.numeric(Firsturine - date_of_admission)) %>% 
	ungroup() %>% 
	select(patient_id, Ventday, Urinecath, Time_to_first_urine) %>% 
	unique()

admission <- admission %>% 
	left_join(days_of_inter, by = "patient_id")

##CAUTI

daily_dt <- daily_dt %>% 
	mutate_at(vars(starts_with("DailyAssessment.culture_date")), ~as.Date(.)) %>% 
	select(-c(DailyAssessment.mechanically_ventilated))

library(data.table)

culture_long <- as.data.table(daily_dt)  %>% 
    melt(measure = patterns("^DailyAssessment.infection","^DailyAssessment.source", 
                            "^DailyAssessment.hos_acquired",
                            "^DailyAssessment.culture_report", "^DailyAssessment.culture_date","^DailyAssessment.type_of_culture", "^DailyAssessment.organism"),
         value.name = c("DailyAssessment.infection","DailyAssessment.source", 
                        "DailyAssessment.hos_acquired",
                        "DailyAssessment.culture_report", "DailyAssessment.culture_date", "DailyAssessment.type_of_culture", "DailyAssessment.organism")) 

##Table
admission %>% select(-c(patient_id, AdmissionAssessment.gcs_eye:Discharge.date_of_hospital_discharge, eye:motor, TetanusAdmission.ablett_score:TetanusAdmission.address, AdmissionAssessment.name_of_the_antibiotic: AdmissionAssessment.name_of_the_antibiotic_other, AdmissionAssessment.mechanically_ventilated_source, TetanusPreDischarge.mechanically_ventilated, TetanusAdmission.period_of_onset)) %>% tbl_summary(by = Ablett, statistic = list(all_continuous() ~ "{mean} ({sd})", all_categorical() ~ "{n} / {N} ({p}%)"
    ), label = c(Admission.age ~ "Age", Admission.gender ~ "Gender", TetanusAdmission.time_period_from_1st_symptom_to_hospital_admis ~ "First symptom to admission")) %>% add_p()


```

